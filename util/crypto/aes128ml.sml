(**
 * rijndael-alg-fst.c
 *
 * @version 3.0 (December 2000)
 *
 * Optimised ANSI C code for the Rijndael cipher (now AES)
 * Now for Standard ML 97.
 *
 * @author Vincent Rijmen <vincent.rijmen@esat.kuleuven.ac.be>
 * @author Antoon Bosselaers <antoon.bosselaers@esat.kuleuven.ac.be>
 * @author Paulo Barreto <paulo.barreto@terra.com.br>
 * @author Wesley W. Terpstra <wesley@terpstra.ca>
 *
 * This code is hereby placed in the public domain.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHORS ''AS IS'' AND ANY EXPRESS
 * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHORS OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
 * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
 * OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
 * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *)

local
   (* Storing big tables in a string is nicely compact in the resulting executable *)
   fun unpack s =
      let
         val b = Byte.stringToBytes s
         fun get i = Word32.fromLarge (PackWord32Big.subVec (b, i))
         
      in
         Word32Vector.tabulate (256, get)
      end
       
   val Te0 = unpack "\
      \\198cc\165\248||\132\238ww\153\246{{\141\255\242\242\r\214kk\189\222oo\177\145\197\197T\
      \`00P\^B\^A\^A\^C\206gg\169V++}\231\254\254\^Y\181\215\215bM\171\171\230\236vv\154\
      \\143\202\202E\^_\130\130\157\137\201\201@\250}}\135\239\250\250\^U\178YY\235\142GG\201\251\240\240\v\
      \A\173\173\236\179\212\212g_\162\162\253E\175\175\234#\156\156\191S\164\164\247\228rr\150\155\192\192[\
      \u\183\183\194\225\253\253\^\=\147\147\174L&&jl66Z~??A\245\247\247\^B\131\204\204O\
      \h44\\Q\165\165\244\209\229\2294\249\241\241\b\226qq\147\171\216\216sb11S*\^U\^U?\
      \\b\^D\^D\f\149\199\199RF##e\157\195\195^0\^X\^X(7\150\150\161\n\^E\^E\^O/\154\154\181\
      \\^N\a\a\t$\^R\^R6\^[\128\128\155\223\226\226=\205\235\235&N''i\127\178\178\205\234uu\159\
      \\^R\t\t\^[\^]\131\131\158X,,t4\^Z\^Z.6\^[\^[-\220nn\178\180ZZ\238[\160\160\251\
      \\164RR\246v;;M\183\214\214a}\179\179\206R)){\221\227\227>^//q\^S\132\132\151\
      \\166SS\245\185\209\209h\^@\^@\^@\^@\193\237\237,@  `\227\252\252\^_y\177\177\200\182[[\237\
      \\212jj\190\141\203\203Fg\190\190\217r99K\148JJ\222\152LL\212\176XX\232\133\207\207J\
      \\187\208\208k\197\239\239*O\170\170\229\237\251\251\^V\134CC\197\154MM\215f33U\^Q\133\133\148\
      \\138EE\207\233\249\249\^P\^D\^B\^B\^F\254\127\127\129\160PP\240x<<D%\159\159\186K\168\168\227\
      \\162QQ\243]\163\163\254\128@@\192\^E\143\143\138?\146\146\173!\157\157\188p88H\241\245\245\^D\
      \c\188\188\223w\182\182\193\175\218\218uB!!c \^P\^P0\229\255\255\^Z\253\243\243\^N\191\210\210m\
      \\129\205\205L\^X\f\f\^T&\^S\^S5\195\236\236/\190__\2255\151\151\162\136DD\204.\^W\^W9\
      \\147\196\196WU\167\167\242\252~~\130z==G\200dd\172\186]]\2312\^Y\^Y+\230ss\149\
      \\192``\160\^Y\129\129\152\158OO\209\163\220\220\127D\"\"fT**~;\144\144\171\v\136\136\131\
      \\140FF\202\199\238\238)k\184\184\211(\^T\^T<\167\222\222y\188^^\226\^V\v\v\^]\173\219\219v\
      \\219\224\224;d22Vt::N\^T\n\n\^^\146II\219\f\^F\^F\nH$$l\184\\\\\228\
      \\159\194\194]\189\211\211nC\172\172\239\196bb\1669\145\145\1681\149\149\164\211\228\2287\242yy\139\
      \\213\231\2312\139\200\200Cn77Y\218mm\183\^A\141\141\140\177\213\213d\156NN\210I\169\169\224\
      \\216ll\180\172VV\250\243\244\244\a\207\234\234%\202ee\175\244zz\142G\174\174\233\^P\b\b\^X\
      \o\186\186\213\240xx\136J%%o\\..r8\^\\^\$W\166\166\241s\180\180\199\151\198\198Q\
      \\203\232\232#\161\221\221|\232tt\156>\^_\^_!\150KK\221a\189\189\220\r\139\139\134\^O\138\138\133\
      \\224pp\144|>>Bq\181\181\196\204ff\170\144HH\216\^F\^C\^C\^E\247\246\246\^A\^\\^N\^N\^R\
      \\194aa\163j55_\174WW\249i\185\185\208\^W\134\134\145\153\193\193X:\^]\^]''\158\158\185\
      \\217\225\2258\235\248\248\^S+\152\152\179\"\^Q\^Q3\210ii\187\169\217\217p\a\142\142\1373\148\148\167\
      \-\155\155\182<\^^\^^\"\^U\135\135\146\201\233\233 \135\206\206I\170UU\255P((x\165\223\223z\
      \\^C\140\140\143Y\161\161\248\t\137\137\128\^Z\r\r\^We\191\191\218\215\230\2301\132BB\198\208hh\184\
      \\130AA\195)\153\153\176Z--w\^^\^O\^O\^Q{\176\176\203\168TT\252m\187\187\214,\^V\^V:"
   val Te1 = unpack "\
      \\165\198cc\132\248||\153\238ww\141\246{{\r\255\242\242\189\214kk\177\222ooT\145\197\197\
      \P`00\^C\^B\^A\^A\169\206gg}V++\^Y\231\254\254b\181\215\215\230M\171\171\154\236vv\
      \E\143\202\202\157\^_\130\130@\137\201\201\135\250}}\^U\239\250\250\235\178YY\201\142GG\v\251\240\240\
      \\236A\173\173g\179\212\212\253_\162\162\234E\175\175\191#\156\156\247S\164\164\150\228rr[\155\192\192\
      \\194u\183\183\^\\225\253\253\174=\147\147jL&&Zl66A~??\^B\245\247\247O\131\204\204\
      \\\h44\244Q\165\1654\209\229\229\b\249\241\241\147\226qqs\171\216\216Sb11?*\^U\^U\
      \\f\b\^D\^DR\149\199\199eF##^\157\195\195(0\^X\^X\1617\150\150\^O\n\^E\^E\181/\154\154\
      \\t\^N\a\a6$\^R\^R\155\^[\128\128=\223\226\226&\205\235\235iN''\205\127\178\178\159\234uu\
      \\^[\^R\t\t\158\^]\131\131tX,,.4\^Z\^Z-6\^[\^[\178\220nn\238\180ZZ\251[\160\160\
      \\246\164RRMv;;a\183\214\214\206}\179\179{R))>\221\227\227q^//\151\^S\132\132\
      \\245\166SSh\185\209\209\^@\^@\^@\^@,\193\237\237`@  \^_\227\252\252\200y\177\177\237\182[[\
      \\190\212jjF\141\203\203\217g\190\190Kr99\222\148JJ\212\152LL\232\176XXJ\133\207\207\
      \k\187\208\208*\197\239\239\229O\170\170\^V\237\251\251\197\134CC\215\154MMUf33\148\^Q\133\133\
      \\207\138EE\^P\233\249\249\^F\^D\^B\^B\129\254\127\127\240\160PPDx<<\186%\159\159\227K\168\168\
      \\243\162QQ\254]\163\163\192\128@@\138\^E\143\143\173?\146\146\188!\157\157Hp88\^D\241\245\245\
      \\223c\188\188\193w\182\182u\175\218\218cB!!0 \^P\^P\^Z\229\255\255\^N\253\243\243m\191\210\210\
      \L\129\205\205\^T\^X\f\f5&\^S\^S/\195\236\236\225\190__\1625\151\151\204\136DD9.\^W\^W\
      \W\147\196\196\242U\167\167\130\252~~Gz==\172\200dd\231\186]]+2\^Y\^Y\149\230ss\
      \\160\192``\152\^Y\129\129\209\158OO\127\163\220\220fD\"\"~T**\171;\144\144\131\v\136\136\
      \\202\140FF)\199\238\238\211k\184\184<(\^T\^Ty\167\222\222\226\188^^\^]\^V\v\vv\173\219\219\
      \;\219\224\224Vd22Nt::\^^\^T\n\n\219\146II\n\f\^F\^FlH$$\228\184\\\\\
      \]\159\194\194n\189\211\211\239C\172\172\166\196bb\1689\145\145\1641\149\1497\211\228\228\139\242yy\
      \2\213\231\231C\139\200\200Yn77\183\218mm\140\^A\141\141d\177\213\213\210\156NN\224I\169\169\
      \\180\216ll\250\172VV\a\243\244\244%\207\234\234\175\202ee\142\244zz\233G\174\174\^X\^P\b\b\
      \\213o\186\186\136\240xxoJ%%r\\..$8\^\\^\\241W\166\166\199s\180\180Q\151\198\198\
      \#\203\232\232|\161\221\221\156\232tt!>\^_\^_\221\150KK\220a\189\189\134\r\139\139\133\^O\138\138\
      \\144\224ppB|>>\196q\181\181\170\204ff\216\144HH\^E\^F\^C\^C\^A\247\246\246\^R\^\\^N\^N\
      \\163\194aa_j55\249\174WW\208i\185\185\145\^W\134\134X\153\193\193':\^]\^]\185'\158\158\
      \8\217\225\225\^S\235\248\248\179+\152\1523\"\^Q\^Q\187\210iip\169\217\217\137\a\142\142\1673\148\148\
      \\182-\155\155\"<\^^\^^\146\^U\135\135 \201\233\233I\135\206\206\255\170UUxP((z\165\223\223\
      \\143\^C\140\140\248Y\161\161\128\t\137\137\^W\^Z\r\r\218e\191\1911\215\230\230\198\132BB\184\208hh\
      \\195\130AA\176)\153\153wZ--\^Q\^^\^O\^O\203{\176\176\252\168TT\214m\187\187:,\^V\^V"
   val Te2 = unpack "\
      \c\165\198c|\132\248|w\153\238w{\141\246{\242\r\255\242k\189\214ko\177\222o\197T\145\197\
      \0P`0\^A\^C\^B\^Ag\169\206g+}V+\254\^Y\231\254\215b\181\215\171\230M\171v\154\236v\
      \\202E\143\202\130\157\^_\130\201@\137\201}\135\250}\250\^U\239\250Y\235\178YG\201\142G\240\v\251\240\
      \\173\236A\173\212g\179\212\162\253_\162\175\234E\175\156\191#\156\164\247S\164r\150\228r\192[\155\192\
      \\183\194u\183\253\^\\225\253\147\174=\147&jL&6Zl6?A~?\247\^B\245\247\204O\131\204\
      \4\\h4\165\244Q\165\2294\209\229\241\b\249\241q\147\226q\216s\171\2161Sb1\^U?*\^U\
      \\^D\f\b\^D\199R\149\199#eF#\195^\157\195\^X(0\^X\150\1617\150\^E\^O\n\^E\154\181/\154\
      \\a\t\^N\a\^R6$\^R\128\155\^[\128\226=\223\226\235&\205\235'iN'\178\205\127\178u\159\234u\
      \\t\^[\^R\t\131\158\^]\131,tX,\^Z.4\^Z\^[-6\^[n\178\220nZ\238\180Z\160\251[\160\
      \R\246\164R;Mv;\214a\183\214\179\206}\179){R)\227>\221\227/q^/\132\151\^S\132\
      \S\245\166S\209h\185\209\^@\^@\^@\^@\237,\193\237 `@ \252\^_\227\252\177\200y\177[\237\182[\
      \j\190\212j\203F\141\203\190\217g\1909Kr9J\222\148JL\212\152LX\232\176X\207J\133\207\
      \\208k\187\208\239*\197\239\170\229O\170\251\^V\237\251C\197\134CM\215\154M3Uf3\133\148\^Q\133\
      \E\207\138E\249\^P\233\249\^B\^F\^D\^B\127\129\254\127P\240\160P<Dx<\159\186%\159\168\227K\168\
      \Q\243\162Q\163\254]\163@\192\128@\143\138\^E\143\146\173?\146\157\188!\1578Hp8\245\^D\241\245\
      \\188\223c\188\182\193w\182\218u\175\218!cB!\^P0 \^P\255\^Z\229\255\243\^N\253\243\210m\191\210\
      \\205L\129\205\f\^T\^X\f\^S5&\^S\236/\195\236_\225\190_\151\1625\151D\204\136D\^W9.\^W\
      \\196W\147\196\167\242U\167~\130\252~=Gz=d\172\200d]\231\186]\^Y+2\^Ys\149\230s\
      \`\160\192`\129\152\^Y\129O\209\158O\220\127\163\220\"fD\"*~T*\144\171;\144\136\131\v\136\
      \F\202\140F\238)\199\238\184\211k\184\^T<(\^T\222y\167\222^\226\188^\v\^]\^V\v\219v\173\219\
      \\224;\219\2242Vd2:Nt:\n\^^\^T\nI\219\146I\^F\n\f\^F$lH$\\\228\184\\\
      \\194]\159\194\211n\189\211\172\239C\172b\166\196b\145\1689\145\149\1641\149\2287\211\228y\139\242y\
      \\2312\213\231\200C\139\2007Yn7m\183\218m\141\140\^A\141\213d\177\213N\210\156N\169\224I\169\
      \l\180\216lV\250\172V\244\a\243\244\234%\207\234e\175\202ez\142\244z\174\233G\174\b\^X\^P\b\
      \\186\213o\186x\136\240x%oJ%.r\\.\^\$8\^\\166\241W\166\180\199s\180\198Q\151\198\
      \\232#\203\232\221|\161\221t\156\232t\^_!>\^_K\221\150K\189\220a\189\139\134\r\139\138\133\^O\138\
      \p\144\224p>B|>\181\196q\181f\170\204fH\216\144H\^C\^E\^F\^C\246\^A\247\246\^N\^R\^\\^N\
      \a\163\194a5_j5W\249\174W\185\208i\185\134\145\^W\134\193X\153\193\^]':\^]\158\185'\158\
      \\2258\217\225\248\^S\235\248\152\179+\152\^Q3\"\^Qi\187\210i\217p\169\217\142\137\a\142\148\1673\148\
      \\155\182-\155\^^\"<\^^\135\146\^U\135\233 \201\233\206I\135\206U\255\170U(xP(\223z\165\223\
      \\140\143\^C\140\161\248Y\161\137\128\t\137\r\^W\^Z\r\191\218e\191\2301\215\230B\198\132Bh\184\208h\
      \A\195\130A\153\176)\153-wZ-\^O\^Q\^^\^O\176\203{\176T\252\168T\187\214m\187\^V:,\^V"
   val Te3 = unpack "\
      \cc\165\198||\132\248ww\153\238{{\141\246\242\242\r\255kk\189\214oo\177\222\197\197T\145\
      \00P`\^A\^A\^C\^Bgg\169\206++}V\254\254\^Y\231\215\215b\181\171\171\230Mvv\154\236\
      \\202\202E\143\130\130\157\^_\201\201@\137}}\135\250\250\250\^U\239YY\235\178GG\201\142\240\240\v\251\
      \\173\173\236A\212\212g\179\162\162\253_\175\175\234E\156\156\191#\164\164\247Srr\150\228\192\192[\155\
      \\183\183\194u\253\253\^\\225\147\147\174=&&jL66Zl??A~\247\247\^B\245\204\204O\131\
      \44\\h\165\165\244Q\229\2294\209\241\241\b\249qq\147\226\216\216s\17111Sb\^U\^U?*\
      \\^D\^D\f\b\199\199R\149##eF\195\195^\157\^X\^X(0\150\150\1617\^E\^E\^O\n\154\154\181/\
      \\a\a\t\^N\^R\^R6$\128\128\155\^[\226\226=\223\235\235&\205''iN\178\178\205\127uu\159\234\
      \\t\t\^[\^R\131\131\158\^],,tX\^Z\^Z.4\^[\^[-6nn\178\220ZZ\238\180\160\160\251[\
      \RR\246\164;;Mv\214\214a\183\179\179\206})){R\227\227>\221//q^\132\132\151\^S\
      \SS\245\166\209\209h\185\^@\^@\^@\^@\237\237,\193  `@\252\252\^_\227\177\177\200y[[\237\182\
      \jj\190\212\203\203F\141\190\190\217g99KrJJ\222\148LL\212\152XX\232\176\207\207J\133\
      \\208\208k\187\239\239*\197\170\170\229O\251\251\^V\237CC\197\134MM\215\15433Uf\133\133\148\^Q\
      \EE\207\138\249\249\^P\233\^B\^B\^F\^D\127\127\129\254PP\240\160<<Dx\159\159\186%\168\168\227K\
      \QQ\243\162\163\163\254]@@\192\128\143\143\138\^E\146\146\173?\157\157\188!88Hp\245\245\^D\241\
      \\188\188\223c\182\182\193w\218\218u\175!!cB\^P\^P0 \255\255\^Z\229\243\243\^N\253\210\210m\191\
      \\205\205L\129\f\f\^T\^X\^S\^S5&\236\236/\195__\225\190\151\151\1625DD\204\136\^W\^W9.\
      \\196\196W\147\167\167\242U~~\130\252==Gzdd\172\200]]\231\186\^Y\^Y+2ss\149\230\
      \``\160\192\129\129\152\^YOO\209\158\220\220\127\163\"\"fD**~T\144\144\171;\136\136\131\v\
      \FF\202\140\238\238)\199\184\184\211k\^T\^T<(\222\222y\167^^\226\188\v\v\^]\^V\219\219v\173\
      \\224\224;\21922Vd::Nt\n\n\^^\^TII\219\146\^F\^F\n\f$$lH\\\\\228\184\
      \\194\194]\159\211\211n\189\172\172\239Cbb\166\196\145\145\1689\149\149\1641\228\2287\211yy\139\242\
      \\231\2312\213\200\200C\13977Ynmm\183\218\141\141\140\^A\213\213d\177NN\210\156\169\169\224I\
      \ll\180\216VV\250\172\244\244\a\243\234\234%\207ee\175\202zz\142\244\174\174\233G\b\b\^X\^P\
      \\186\186\213oxx\136\240%%oJ..r\\\^\\^\$8\166\166\241W\180\180\199s\198\198Q\151\
      \\232\232#\203\221\221|\161tt\156\232\^_\^_!>KK\221\150\189\189\220a\139\139\134\r\138\138\133\^O\
      \pp\144\224>>B|\181\181\196qff\170\204HH\216\144\^C\^C\^E\^F\246\246\^A\247\^N\^N\^R\^\\
      \aa\163\19455_jWW\249\174\185\185\208i\134\134\145\^W\193\193X\153\^]\^]':\158\158\185'\
      \\225\2258\217\248\248\^S\235\152\152\179+\^Q\^Q3\"ii\187\210\217\217p\169\142\142\137\a\148\148\1673\
      \\155\155\182-\^^\^^\"<\135\135\146\^U\233\233 \201\206\206I\135UU\255\170((xP\223\223z\165\
      \\140\140\143\^C\161\161\248Y\137\137\128\t\r\r\^W\^Z\191\191\218e\230\2301\215BB\198\132hh\184\208\
      \AA\195\130\153\153\176)--wZ\^O\^O\^Q\^^\176\176\203{TT\252\168\187\187\214m\^V\^V:,"
   val Te4 = unpack "\
      \cccc||||wwww{{{{\242\242\242\242kkkkoooo\197\197\197\197\
      \0000\^A\^A\^A\^Agggg++++\254\254\254\254\215\215\215\215\171\171\171\171vvvv\
      \\202\202\202\202\130\130\130\130\201\201\201\201}}}}\250\250\250\250YYYYGGGG\240\240\240\240\
      \\173\173\173\173\212\212\212\212\162\162\162\162\175\175\175\175\156\156\156\156\164\164\164\164rrrr\192\192\192\192\
      \\183\183\183\183\253\253\253\253\147\147\147\147&&&&6666????\247\247\247\247\204\204\204\204\
      \4444\165\165\165\165\229\229\229\229\241\241\241\241qqqq\216\216\216\2161111\^U\^U\^U\^U\
      \\^D\^D\^D\^D\199\199\199\199####\195\195\195\195\^X\^X\^X\^X\150\150\150\150\^E\^E\^E\^E\154\154\154\154\
      \\a\a\a\a\^R\^R\^R\^R\128\128\128\128\226\226\226\226\235\235\235\235''''\178\178\178\178uuuu\
      \\t\t\t\t\131\131\131\131,,,,\^Z\^Z\^Z\^Z\^[\^[\^[\^[nnnnZZZZ\160\160\160\160\
      \RRRR;;;;\214\214\214\214\179\179\179\179))))\227\227\227\227////\132\132\132\132\
      \SSSS\209\209\209\209\^@\^@\^@\^@\237\237\237\237    \252\252\252\252\177\177\177\177[[[[\
      \jjjj\203\203\203\203\190\190\190\1909999JJJJLLLLXXXX\207\207\207\207\
      \\208\208\208\208\239\239\239\239\170\170\170\170\251\251\251\251CCCCMMMM3333\133\133\133\133\
      \EEEE\249\249\249\249\^B\^B\^B\^B\127\127\127\127PPPP<<<<\159\159\159\159\168\168\168\168\
      \QQQQ\163\163\163\163@@@@\143\143\143\143\146\146\146\146\157\157\157\1578888\245\245\245\245\
      \\188\188\188\188\182\182\182\182\218\218\218\218!!!!\^P\^P\^P\^P\255\255\255\255\243\243\243\243\210\210\210\210\
      \\205\205\205\205\f\f\f\f\^S\^S\^S\^S\236\236\236\236____\151\151\151\151DDDD\^W\^W\^W\^W\
      \\196\196\196\196\167\167\167\167~~~~====dddd]]]]\^Y\^Y\^Y\^Yssss\
      \````\129\129\129\129OOOO\220\220\220\220\"\"\"\"****\144\144\144\144\136\136\136\136\
      \FFFF\238\238\238\238\184\184\184\184\^T\^T\^T\^T\222\222\222\222^^^^\v\v\v\v\219\219\219\219\
      \\224\224\224\2242222::::\n\n\n\nIIII\^F\^F\^F\^F$$$$\\\\\\\\\
      \\194\194\194\194\211\211\211\211\172\172\172\172bbbb\145\145\145\145\149\149\149\149\228\228\228\228yyyy\
      \\231\231\231\231\200\200\200\2007777mmmm\141\141\141\141\213\213\213\213NNNN\169\169\169\169\
      \llllVVVV\244\244\244\244\234\234\234\234eeeezzzz\174\174\174\174\b\b\b\b\
      \\186\186\186\186xxxx%%%%....\^\\^\\^\\^\\166\166\166\166\180\180\180\180\198\198\198\198\
      \\232\232\232\232\221\221\221\221tttt\^_\^_\^_\^_KKKK\189\189\189\189\139\139\139\139\138\138\138\138\
      \pppp>>>>\181\181\181\181ffffHHHH\^C\^C\^C\^C\246\246\246\246\^N\^N\^N\^N\
      \aaaa5555WWWW\185\185\185\185\134\134\134\134\193\193\193\193\^]\^]\^]\^]\158\158\158\158\
      \\225\225\225\225\248\248\248\248\152\152\152\152\^Q\^Q\^Q\^Qiiii\217\217\217\217\142\142\142\142\148\148\148\148\
      \\155\155\155\155\^^\^^\^^\^^\135\135\135\135\233\233\233\233\206\206\206\206UUUU((((\223\223\223\223\
      \\140\140\140\140\161\161\161\161\137\137\137\137\r\r\r\r\191\191\191\191\230\230\230\230BBBBhhhh\
      \AAAA\153\153\153\153----\^O\^O\^O\^O\176\176\176\176TTTT\187\187\187\187\^V\^V\^V\^V"
(*
   val Td0 = unpack "\
      \Q\244\167P~AeS\^Z\^W\164\195:'^\150;\171k\203\^_\157E\241\172\250X\171K\227\^C\147\
      \ 0\250U\173vm\246\136\204v\145\245\^BL%O\229\215\252\197*\203\215&5D\128\181b\163\143\
      \\222\177ZI%\186\^[gE\234\^N\152]\254\192\225\195/u\^B\129L\240\^R\141F\151\163k\211\249\198\
      \\^C\143_\231\^U\146\156\149\191mz\235\149RY\218\212\190\131-Xt!\211I\224i)\142\201\200D\
      \u\194\137j\244\142yx\153X>k'\185q\221\190\225O\182\240\136\173\^W\201 \172f}\206:\180\
      \c\223J\^X\229\^Z1\130\151Q3`bS\127E\177dw\224\187k\174\132\254\129\160\^\\249\b+\148\
      \pHhX\143E\253\^Y\148\222l\135R{\248\183\171s\211#rK\^B\226\227\^_\143WfU\171*\
      \\178\235(\a/\181\194\^C\134\197{\154\2117\b\1650(\135\242#\191\165\178\^B\^Cj\186\237\^V\130\\\
      \\138\207\^\+\167y\180\146\243\a\242\240Ni\226\161e\218\244\205\^F\^E\190\213\2094b\^_\196\166\254\138\
      \4.S\157\162\243U\160\^E\138\2252\164\246\235u\v\131\2369@`\239\170^q\159\^F\189n\^PQ\
      \>!\138\249\150\221\^F=\221>\^E\174M\230\189F\145T\141\181q\196]\^E\^D\^F\212o`P\^U\255\
      \\^Y\152\251$\214\189\233\151\137@C\204g\217\158w\176\232B\189\a\137\139\136\231\^Y[8y\200\238\219\
      \\161|\nG|B\^O\233\248\132\^^\201\^@\^@\^@\^@\t\128\134\1312+\237H\^^\^Qp\172lZrN\
      \\253\^N\255\251\^O\1338V=\174\213\^^6-9'\n\^O\217dh\\\166!\155[T\209$6.:\
      \\f\ng\177\147W\231\^O\180\238\150\210\^[\155\145\158\128\192\197Oa\220 \162ZwKi\^\\^R\^Z\^V\
      \\226\147\186\n\192\160*\229<\"\224C\^R\^[\^W\^]\^N\t\r\v\242\139\199\173-\182\168\185\^T\^^\169\200\
      \W\241\^Y\133\175u\aL\238\153\221\187\163\127`\253\247\^A&\159\\r\245\188Df;\197[\251~4\
      \\139C)v\203#\198\220\182\237\252h\184\228\241c\2151\220\202Bc\133\^P\^S\151\"@\132\198\^Q \
      \\133J$}\210\187=\248\174\2492\^Q\199)\161m\^]\158/K\220\1780\243\r\134R\236w\193\227\208\
      \+\179\^Vl\169p\185\153\^Q\148H\250G\233d\"\168\252\140\196\160\240?\^ZV},\216\"3\144\239\
      \\135IN\199\2178\209\193\140\202\162\254\152\212\v6\166\245\129\207\165z\222(\218\183\142&?\173\191\164\
      \,:\157\228Px\146\rj_\204\155T~Fb\246\141\^S\194\144\216\184\232.9\247^\130\195\175\245\
      \\159]\128\190i\208\147|o\213-\169\207%\^R\179\200\172\153;\^P\^X}\167\232\156cn\219;\187{\
      \\205&x\tnY\^X\244\236\154\183\^A\131O\154\168\230\149ne\170\255\230~!\188\207\b\239\^U\232\230\
      \\186\231\155\217Jo6\206\234\159\t\212)\176|\2141\164\178\175*?#1\198\165\14805\162f\192\
      \tN\1887\252\130\202\166\224\144\208\1763\167\216\^U\241\^D\152JA\236\218\247\127\205P\^N\^W\145\246/\
      \vM\214\141C\239\176M\204\170MT\228\150\^D\223\158\209\181\227Lj\136\^[\193,\^_\184FeQ\127\
      \\157^\234\^D\^A\1405]\250\135ts\251\vA.\179g\^]Z\146\219\210R\233\^PV3m\214G\^S\
      \\154\215a\1407\161\fzY\248\^T\142\235\^S<\137\206\169'\238\183a\2015\225\^\\229\237zG\177<\
      \\156\210\223YU\242s?\^X\^T\206ys\1997\191S\247\205\234_\253\170[\223=o\^TxD\219\134\
      \\202\175\243\129\185h\196>8$4,\194\163@_\^V\^]\195r\188\226%\f(<I\139\255\r\149A\
      \9\168\^Aq\b\f\179\222\216\180\228\156dV\193\144{\203\132a\2132\182pHl\\t\208\184WB"
   val Td1 = unpack "\
      \PQ\244\167S~Ae\195\^Z\^W\164\150:'^\203;\171k\241\^_\157E\171\172\250X\147K\227\^C\
      \U 0\250\246\173vm\145\136\204v%\245\^BL\252O\229\215\215\197*\203\128&5D\143\181b\163\
      \I\222\177Zg%\186\^[\152E\234\^N\225]\254\192\^B\195/u\^R\129L\240\163\141F\151\198k\211\249\
      \\231\^C\143_\149\^U\146\156\235\191mz\218\149RY-\212\190\131\211Xt!)I\224iD\142\201\200\
      \ju\194\137x\244\142yk\153X>\221'\185q\182\190\225O\^W\240\136\173f\201 \172\180}\206:\
      \\^Xc\223J\130\229\^Z1`\151Q3EbS\127\224\177dw\132\187k\174\^\\254\129\160\148\249\b+\
      \XpHh\^Y\143E\253\135\148\222l\183R{\248#\171s\211\226rK\^BW\227\^_\143*fU\171\
      \\a\178\235(\^C/\181\194\154\134\197{\165\2117\b\2420(\135\178#\191\165\186\^B\^Cj\\\237\^V\130\
      \+\138\207\^\\146\167y\180\240\243\a\242\161Ni\226\205e\218\244\213\^F\^E\190\^_\2094b\138\196\166\254\
      \\1574.S\160\162\243U2\^E\138\225u\164\246\2359\v\131\236\170@`\239\^F^q\159Q\189n\^P\
      \\249>!\138=\150\221\^F\174\221>\^EFM\230\189\181\145T\141\^Eq\196]o\^D\^F\212\255`P\^U\
      \$\^Y\152\251\151\214\189\233\204\137@Cwg\217\158\189\176\232B\136\a\137\1398\231\^Y[\219y\200\238\
      \G\161|\n\233|B\^O\201\248\132\^^\^@\^@\^@\^@\131\t\128\134H2+\237\172\^^\^QpNlZr\
      \\251\253\^N\255V\^O\1338\^^=\174\213'6-9d\n\^O\217!h\\\166\209\155[T:$6.\
      \\177\f\ng\^O\147W\231\210\180\238\150\158\^[\155\145O\128\192\197\162a\220 iZwK\^V\^\\^R\^Z\
      \\n\226\147\186\229\192\160*C<\"\224\^]\^R\^[\^W\v\^N\t\r\173\242\139\199\185-\182\168\200\^T\^^\169\
      \\133W\241\^YL\175u\a\187\238\153\221\253\163\127`\159\247\^A&\188\\r\245\197Df;4[\251~\
      \v\139C)\220\203#\198h\182\237\252c\184\228\241\202\2151\220\^PBc\133@\^S\151\" \132\198\^Q\
      \}\133J$\248\210\187=\^Q\174\2492m\199)\161K\^]\158/\243\220\1780\236\r\134R\208w\193\227\
      \l+\179\^V\153\169p\185\250\^Q\148H\"G\233d\196\168\252\140\^Z\160\240?\216V},\239\"3\144\
      \\199\135IN\193\2178\209\254\140\202\1626\152\212\v\207\166\245\129(\165z\222&\218\183\142\164?\173\191\
      \\228,:\157\rPx\146\155j_\204bT~F\194\246\141\^S\232\144\216\184^.9\247\245\130\195\175\
      \\190\159]\128|i\208\147\169o\213-\179\207%\^R;\200\172\153\167\^P\^X}n\232\156c{\219;\187\
      \\t\205&x\244nY\^X\^A\236\154\183\168\131O\154e\230\149n~\170\255\230\b!\188\207\230\239\^U\232\
      \\217\186\231\155\206Jo6\212\234\159\t\214)\176|\1751\164\1781*?#0\198\165\148\1925\162f\
      \7tN\188\166\252\130\202\176\224\144\208\^U3\167\216J\241\^D\152\247A\236\218\^N\127\205P/\^W\145\246\
      \\141vM\214MC\239\176T\204\170M\223\228\150\^D\227\158\209\181\^[Lj\136\184\193,\^_\127FeQ\
      \\^D\157^\234]\^A\1405s\250\135t.\251\vAZ\179g\^]R\146\219\2103\233\^PV\^Sm\214G\
      \\140\154\215az7\161\f\142Y\248\^T\137\235\^S<\238\206\169'5\183a\201\237\225\^\\229<zG\177\
      \Y\156\210\223?U\242sy\^X\^T\206\191s\1997\234S\247\205[_\253\170\^T\223=o\134xD\219\
      \\129\202\175\243>\185h\196,8$4_\194\163@r\^V\^]\195\f\188\226%\139(<IA\255\r\149\
      \q9\168\^A\222\b\f\179\156\216\180\228\144dV\193a{\203\132p\2132\182tHl\\B\208\184W"
   val Td2 = unpack "\
      \\167PQ\244eS~A\164\195\^Z\^W^\150:'k\203;\171E\241\^_\157X\171\172\250\^C\147K\227\
      \\250U 0m\246\173vv\145\136\204L%\245\^B\215\252O\229\203\215\197*D\128&5\163\143\181b\
      \ZI\222\177\^[g%\186\^N\152E\234\192\225]\254u\^B\195/\240\^R\129L\151\163\141F\249\198k\211\
      \_\231\^C\143\156\149\^U\146z\235\191mY\218\149R\131-\212\190!\211Xti)I\224\200D\142\201\
      \\137ju\194yx\244\142>k\153Xq\221'\185O\182\190\225\173\^W\240\136\172f\201 :\180}\206\
      \J\^Xc\2231\130\229\^Z3`\151Q\127EbSw\224\177d\174\132\187k\160\^\\254\129+\148\249\b\
      \hXpH\253\^Y\143El\135\148\222\248\183R{\211#\171s\^B\226rK\143W\227\^_\171*fU\
      \(\a\178\235\194\^C/\181{\154\134\197\b\165\2117\135\2420(\165\178#\191j\186\^B\^C\130\\\237\^V\
      \\^\+\138\207\180\146\167y\242\240\243\a\226\161Ni\244\205e\218\190\213\^F\^Eb\^_\2094\254\138\196\166\
      \S\1574.U\160\162\243\2252\^E\138\235u\164\246\2369\v\131\239\170@`\159\^F^q\^PQ\189n\
      \\138\249>!\^F=\150\221\^E\174\221>\189FM\230\141\181\145T]\^Eq\196\212o\^D\^F\^U\255`P\
      \\251$\^Y\152\233\151\214\189C\204\137@\158wg\217B\189\176\232\139\136\a\137[8\231\^Y\238\219y\200\
      \\nG\161|\^O\233|B\^^\201\248\132\^@\^@\^@\^@\134\131\t\128\237H2+p\172\^^\^QrNlZ\
      \\255\251\253\^N8V\^O\133\213\^^=\1749'6-\217d\n\^O\166!h\\T\209\155[.:$6\
      \g\177\f\n\231\^O\147W\150\210\180\238\145\158\^[\155\197O\128\192 \162a\220KiZw\^Z\^V\^\\^R\
      \\186\n\226\147*\229\192\160\224C<\"\^W\^]\^R\^[\r\v\^N\t\199\173\242\139\168\185-\182\169\200\^T\^^\
      \\^Y\133W\241\aL\175u\221\187\238\153`\253\163\127&\159\247\^A\245\188\\r;\197Df~4[\251\
      \)v\139C\198\220\203#\252h\182\237\241c\184\228\220\202\2151\133\^PBc\"@\^S\151\^Q \132\198\
      \$}\133J=\248\210\1872\^Q\174\249\161m\199)/K\^]\1580\243\220\178R\236\r\134\227\208w\193\
      \\^Vl+\179\185\153\169pH\250\^Q\148d\"G\233\140\196\168\252?\^Z\160\240,\216V}\144\239\"3\
      \N\199\135I\209\193\2178\162\254\140\202\v6\152\212\129\207\166\245\222(\165z\142&\218\183\191\164?\173\
      \\157\228,:\146\rPx\204\155j_FbT~\^S\194\246\141\184\232\144\216\247^.9\175\245\130\195\
      \\128\190\159]\147|i\208-\169o\213\^R\179\207%\153;\200\172}\167\^P\^Xcn\232\156\187{\219;\
      \x\t\205&\^X\244nY\183\^A\236\154\154\168\131One\230\149\230~\170\255\207\b!\188\232\230\239\^U\
      \\155\217\186\2316\206Jo\t\212\234\159|\214)\176\178\1751\164#1*?\1480\198\165f\1925\162\
      \\1887tN\202\166\252\130\208\176\224\144\216\^U3\167\152J\241\^D\218\247A\236P\^N\127\205\246/\^W\145\
      \\214\141vM\176MC\239MT\204\170\^D\223\228\150\181\227\158\209\136\^[Lj\^_\184\193,Q\127Fe\
      \\234\^D\157^5]\^A\140ts\250\135A.\251\v\^]Z\179g\210R\146\219V3\233\^PG\^Sm\214\
      \a\140\154\215\fz7\161\^T\142Y\248<\137\235\^S'\238\206\169\2015\183a\229\237\225\^\\177<zG\
      \\223Y\156\210s?U\242\206y\^X\^T7\191s\199\205\234S\247\170[_\253o\^T\223=\219\134xD\
      \\243\129\202\175\196>\185h4,8$@_\194\163\195r\^V\^]%\f\188\226I\139(<\149A\255\r\
      \\^Aq9\168\179\222\b\f\228\156\216\180\193\144dV\132a{\203\182p\2132\\tHlWB\208\184"
   val Td3 = unpack "\
      \\244\167PQAeS~\^W\164\195\^Z'^\150:\171k\203;\157E\241\^_\250X\171\172\227\^C\147K\
      \0\250U vm\246\173\204v\145\136\^BL%\245\229\215\252O*\203\215\1975D\128&b\163\143\181\
      \\177ZI\222\186\^[g%\234\^N\152E\254\192\225]/u\^B\195L\240\^R\129F\151\163\141\211\249\198k\
      \\143_\231\^C\146\156\149\^Umz\235\191RY\218\149\190\131-\212t!\211X\224i)I\201\200D\142\
      \\194\137ju\142yx\244X>k\153\185q\221'\225O\182\190\136\173\^W\240 \172f\201\206:\180}\
      \\223J\^Xc\^Z1\130\229Q3`\151S\127Ebdw\224\177k\174\132\187\129\160\^\\254\b+\148\249\
      \HhXpE\253\^Y\143\222l\135\148{\248\183Rs\211#\171K\^B\226r\^_\143W\227U\171*f\
      \\235(\a\178\181\194\^C/\197{\154\1347\b\165\211(\135\2420\191\165\178#\^Cj\186\^B\^V\130\\\237\
      \\207\^\+\138y\180\146\167\a\242\240\243i\226\161N\218\244\205e\^E\190\213\^F4b\^_\209\166\254\138\196\
      \.S\1574\243U\160\162\138\2252\^E\246\235u\164\131\2369\v`\239\170@q\159\^F^n\^PQ\189\
      \!\138\249>\221\^F=\150>\^E\174\221\230\189FMT\141\181\145\196]\^Eq\^F\212o\^DP\^U\255`\
      \\152\251$\^Y\189\233\151\214@C\204\137\217\158wg\232B\189\176\137\139\136\a\^Y[8\231\200\238\219y\
      \|\nG\161B\^O\233|\132\^^\201\248\^@\^@\^@\^@\128\134\131\t+\237H2\^Qp\172\^^ZrNl\
      \\^N\255\251\253\1338V\^O\174\213\^^=-9'6\^O\217d\n\\\166!h[T\209\1556.:$\
      \\ng\177\fW\231\^O\147\238\150\210\180\155\145\158\^[\192\197O\128\220 \162awKiZ\^R\^Z\^V\^\\
      \\147\186\n\226\160*\229\192\"\224C<\^[\^W\^]\^R\t\r\v\^N\139\199\173\242\182\168\185-\^^\169\200\^T\
      \\241\^Y\133Wu\aL\175\153\221\187\238\127`\253\163\^A&\159\247r\245\188\\f;\197D\251~4[\
      \C)v\139#\198\220\203\237\252h\182\228\241c\1841\220\202\215c\133\^PB\151\"@\^S\198\^Q \132\
      \J$}\133\187=\248\210\2492\^Q\174)\161m\199\158/K\^]\1780\243\220\134R\236\r\193\227\208w\
      \\179\^Vl+p\185\153\169\148H\250\^Q\233d\"G\252\140\196\168\240?\^Z\160},\216V3\144\239\"\
      \IN\199\1358\209\193\217\202\162\254\140\212\v6\152\245\129\207\166z\222(\165\183\142&\218\173\191\164?\
      \:\157\228,x\146\rP_\204\155j~FbT\141\^S\194\246\216\184\232\1449\247^.\195\175\245\130\
      \]\128\190\159\208\147|i\213-\169o%\^R\179\207\172\153;\200\^X}\167\^P\156cn\232;\187{\219\
      \&x\t\205Y\^X\244n\154\183\^A\236O\154\168\131\149ne\230\255\230~\170\188\207\b!\^U\232\230\239\
      \\231\155\217\186o6\206J\159\t\212\234\176|\214)\164\178\1751?#1*\165\1480\198\162f\1925\
      \N\1887t\130\202\166\252\144\208\176\224\167\216\^U3\^D\152J\241\236\218\247A\205P\^N\127\145\246/\^W\
      \M\214\141v\239\176MC\170MT\204\150\^D\223\228\209\181\227\158j\136\^[L,\^_\184\193eQ\127F\
      \^\234\^D\157\1405]\^A\135ts\250\vA.\251g\^]Z\179\219\210R\146\^PV3\233\214G\^Sm\
      \\215a\140\154\161\fz7\248\^T\142Y\^S<\137\235\169'\238\206a\2015\183\^\\229\237\225G\177<z\
      \\210\223Y\156\242s?U\^T\206y\^X\1997\191s\247\205\234S\253\170[_=o\^T\223D\219\134x\
      \\175\243\129\202h\196>\185$4,8\163@_\194\^]\195r\^V\226%\f\188<I\139(\r\149A\255\
      \\168\^Aq9\f\179\222\b\180\228\156\216V\193\144d\203\132a{2\182p\213l\\tH\184WB\208"
   val Td4 = unpack "\
      \RRRR\t\t\t\tjjjj\213\213\213\21300006666\165\165\165\1658888\
      \\191\191\191\191@@@@\163\163\163\163\158\158\158\158\129\129\129\129\243\243\243\243\215\215\215\215\251\251\251\251\
      \||||\227\227\227\2279999\130\130\130\130\155\155\155\155////\255\255\255\255\135\135\135\135\
      \4444\142\142\142\142CCCCDDDD\196\196\196\196\222\222\222\222\233\233\233\233\203\203\203\203\
      \TTTT{{{{\148\148\148\1482222\166\166\166\166\194\194\194\194####====\
      \\238\238\238\238LLLL\149\149\149\149\v\v\v\vBBBB\250\250\250\250\195\195\195\195NNNN\
      \\b\b\b\b....\161\161\161\161ffff((((\217\217\217\217$$$$\178\178\178\178\
      \vvvv[[[[\162\162\162\162IIIImmmm\139\139\139\139\209\209\209\209%%%%\
      \rrrr\248\248\248\248\246\246\246\246dddd\134\134\134\134hhhh\152\152\152\152\^V\^V\^V\^V\
      \\212\212\212\212\164\164\164\164\\\\\\\\\204\204\204\204]]]]eeee\182\182\182\182\146\146\146\146\
      \llllppppHHHHPPPP\253\253\253\253\237\237\237\237\185\185\185\185\218\218\218\218\
      \^^^^\^U\^U\^U\^UFFFFWWWW\167\167\167\167\141\141\141\141\157\157\157\157\132\132\132\132\
      \\144\144\144\144\216\216\216\216\171\171\171\171\^@\^@\^@\^@\140\140\140\140\188\188\188\188\211\211\211\211\n\n\n\n\
      \\247\247\247\247\228\228\228\228XXXX\^E\^E\^E\^E\184\184\184\184\179\179\179\179EEEE\^F\^F\^F\^F\
      \\208\208\208\208,,,,\^^\^^\^^\^^\143\143\143\143\202\202\202\202????\^O\^O\^O\^O\^B\^B\^B\^B\
      \\193\193\193\193\175\175\175\175\189\189\189\189\^C\^C\^C\^C\^A\^A\^A\^A\^S\^S\^S\^S\138\138\138\138kkkk\
      \::::\145\145\145\145\^Q\^Q\^Q\^QAAAAOOOOgggg\220\220\220\220\234\234\234\234\
      \\151\151\151\151\242\242\242\242\207\207\207\207\206\206\206\206\240\240\240\240\180\180\180\180\230\230\230\230ssss\
      \\150\150\150\150\172\172\172\172tttt\"\"\"\"\231\231\231\231\173\173\173\1735555\133\133\133\133\
      \\226\226\226\226\249\249\249\2497777\232\232\232\232\^\\^\\^\\^\uuuu\223\223\223\223nnnn\
      \GGGG\241\241\241\241\^Z\^Z\^Z\^Zqqqq\^]\^]\^]\^]))))\197\197\197\197\137\137\137\137\
      \oooo\183\183\183\183bbbb\^N\^N\^N\^N\170\170\170\170\^X\^X\^X\^X\190\190\190\190\^[\^[\^[\^[\
      \\252\252\252\252VVVV>>>>KKKK\198\198\198\198\210\210\210\210yyyy    \
      \\154\154\154\154\219\219\219\219\192\192\192\192\254\254\254\254xxxx\205\205\205\205ZZZZ\244\244\244\244\
      \\^_\^_\^_\^_\221\221\221\221\168\168\168\1683333\136\136\136\136\a\a\a\a\199\199\199\1991111\
      \\177\177\177\177\^R\^R\^R\^R\^P\^P\^P\^PYYYY''''\128\128\128\128\236\236\236\236____\
      \````QQQQ\127\127\127\127\169\169\169\169\^Y\^Y\^Y\^Y\181\181\181\181JJJJ\r\r\r\r\
      \----\229\229\229\229zzzz\159\159\159\159\147\147\147\147\201\201\201\201\156\156\156\156\239\239\239\239\
      \\160\160\160\160\224\224\224\224;;;;MMMM\174\174\174\174****\245\245\245\245\176\176\176\176\
      \\200\200\200\200\235\235\235\235\187\187\187\187<<<<\131\131\131\131SSSS\153\153\153\153aaaa\
      \\^W\^W\^W\^W++++\^D\^D\^D\^D~~~~\186\186\186\186wwww\214\214\214\214&&&&\
      \\225\225\225\225iiii\^T\^T\^T\^TccccUUUU!!!!\f\f\f\f}}}}"
*)
   
   (* for 128-bit blocks, Rijndael never uses more than 10 rcon values *)
   val rcont = Word32Vector.fromList [
      0wx01000000, 0wx02000000, 0wx04000000, 0wx08000000,
      0wx10000000, 0wx20000000, 0wx40000000, 0wx80000000,
      0wx1B000000, 0wx36000000 ]

   local
      open Serial
   in
      val w32x4b = aggregate tuple4 `word32b `word32b `word32b `word32b $
      val { writeSlice, parseSlice, ... } = methods w32x4b
      fun writer s x = writeSlice (s, x)
   end
   
   local
      open Word32
      infix 6 & ^
      infix 5 >>
      fun a + b = Int.+ (a, b)
      fun a & b = andb (a, b)
      fun a ^ b = xorb (a, b)
      
      fun te40 w = Word32Vector.sub (Te4, Word32.toInt ((w >> 0w16) & 0wxff)) & 0wxff000000
      fun te41 w = Word32Vector.sub (Te4, Word32.toInt ((w >> 0w08) & 0wxff)) & 0wx00ff0000
      fun te42 w = Word32Vector.sub (Te4, Word32.toInt ((w        ) & 0wxff)) & 0wx0000ff00
      fun te43 w = Word32Vector.sub (Te4, Word32.toInt ((w >> 0w24)        )) & 0wx000000ff
      fun te4 w = te40 w ^ te41 w ^ te42 w ^ te43 w
      
(*
      fun te50 w = Word32Vector.sub (Te4, Word32.toInt ((w >> 0w24)        )) & 0wxff000000
      fun te51 w = Word32Vector.sub (Te4, Word32.toInt ((w >> 0w16) & 0wxff)) & 0wx00ff0000
      fun te52 w = Word32Vector.sub (Te4, Word32.toInt ((w >> 0w08) & 0wxff)) & 0wx0000ff00
      fun te53 w = Word32Vector.sub (Te4, Word32.toInt ((w        ) & 0wxff)) & 0wx000000ff
      fun te5 w = te50 w ^ te51 w ^ te52 w ^ te53 w
*)
   in
      (* Expand the cipher key into the encryption key schedule *)
      fun keySetupEnc128(key : Word32Array.array -> unit) =
         let
            val rk = Word32Array.tabulate (44, fn _ => 0w0) (* 4*(Nr+1) *)
            fun sub i = Word32Array.sub (rk, i)
            fun update (i, w) = Word32Array.update (rk, i, w)
            fun rcon i = Word32Vector.sub (rcont, Int.div (i, 4))
            
            val () = key rk
            fun loop i =
               let
                  val () = update (i+4, sub (i  ) ^ te4 (sub (i+3)) ^ rcon i)
                  val () = update (i+5, sub (i+1) ^ sub (i+4))
                  val () = update (i+6, sub (i+2) ^ sub (i+5))
                  val () = update (i+7, sub (i+3) ^ sub (i+6))
               in
                  if i = 36 then () else loop (i + 4)
               end
         in
            loop 0
            ; rk
         end
      
(*
      fun keySetupEnc192(key : Word32Array.array -> unit) =
         let
            val rk = Word32Array.tabulate (52, fn _ => 0w0) (* 4*(Nr+1) *)
            fun sub i = Word32Array.sub (rk, i)
            fun update (i, w) = Word32Array.update (rk, i, w)
            fun rcon i = Word32Vector.sub (rcont, Int.div (i, 6))
            
            val () = key rk 
            fun loop i =
               let
                  val () = update (i+6, sub (i  ) ^ te4 (sub (i+5)) ^ rcon i)
                  val () = update (i+7, sub (i+1) ^ sub (i+6))
                  val () = update (i+8, sub (i+2) ^ sub (i+7))
                  val () = update (i+9, sub (i+3) ^ sub (i+8))
               in
                  if i = 42 then () else
                  (update (i+10, sub (i+4) ^ sub (i+9))
                   ; update (i+11, sub (i+5) ^ sub (i+10))
                   ; loop (i + 6))
               end
         in
            loop 0
            ; rk
         end
      
      fun keySetupEnc256(key : Word32Array.array -> unit) =
         let
            val rk = Word32Array.tabulate (60, fn _ => 0w0) (* 4*(Nr+1) *)
            fun sub i = Word32Array.sub (rk, i)
            fun update (i, w) = Word32Array.update (rk, i, w)
            fun rcon i = Word32Vector.sub (rcont, Int.div (i, 8))
            
            val () = key rk
            fun loop i =
               let
                  val () = update (i+8, sub (i  ) ^ te4 (sub (i+7)) ^ rcon i)
                  val () = update (i+9, sub (i+1) ^ sub (i+8))
                  val () = update (i+10, sub (i+2) ^ sub (i+9))
                  val () = update (i+11, sub (i+3) ^ sub (i+10))
               in
                  if i = 48 then () else
                  (update (i+12, sub (i+4) ^ te5 (sub (i+11)))
                   ; update (i+13, sub (i+5) ^ sub (i+12))
                   ; update (i+14, sub (i+6) ^ sub (i+13))
                   ; update (i+15, sub (i+7) ^ sub (i+14))
                   ; loop (i + 8))
               end
         in
            loop 0
            ; rk
         end
*)
   end
   
(*
   local
      open Word32
      infix 6 & ^
      infix 5 >>
      fun a - b = Int.- (a, b)
      fun a & b = andb (a, b)
      fun a ^ b = xorb (a, b)
      
      fun flip128 b = 
         let
            open Int
            val len = Word32Array.length b
            fun map i = len - 4 - i + (i mod 4) * 2
         in
            Word32Array.tabulate (len, fn i => Word32Array.sub (b, map i))
         end
      
      fun te40 w = Word32Vector.sub (Te4, Word32.toInt ((w >> 0w24)        ))
      fun te41 w = Word32Vector.sub (Te4, Word32.toInt ((w >> 0w16) & 0wxff))
      fun te42 w = Word32Vector.sub (Te4, Word32.toInt ((w >> 0w08) & 0wxff))
      fun te43 w = Word32Vector.sub (Te4, Word32.toInt ((w        ) & 0wxff))
      fun td40 w = Word32Vector.sub (Td0, Word32.toInt (te40 w & 0wxff))
      fun td41 w = Word32Vector.sub (Td1, Word32.toInt (te41 w & 0wxff))
      fun td42 w = Word32Vector.sub (Td2, Word32.toInt (te42 w & 0wxff))
      fun td43 w = Word32Vector.sub (Td3, Word32.toInt (te43 w & 0wxff))
      fun invert w = td40 w ^ td41 w ^ td42 w ^ td43 w
      
      fun cutLowHigh b =
         Word32ArraySlice.slice (b, 4, SOME (Word32Array.length b - 8))
      val invert = fn b =>
         Word32ArraySlice.modify invert (cutLowHigh b)
   in
      (* Expand the cipher key into the decryption key schedule. *)
      fun keySetupDec(rk : Word32Array.array) =
         let
            val rk = flip128 rk
            val () = invert rk
         in
            rk
         end
   end
*)
   
   fun fetch rk s =
      let
         val (a, b, c, d) = parseSlice s
         fun a ^ b = Word32.xorb (a, b)
      in
         (a ^ Word32Vector.sub (rk, 0),
          b ^ Word32Vector.sub (rk, 1),
          c ^ Word32Vector.sub (rk, 2),
          d ^ Word32Vector.sub (rk, 3))
      end
   
   local
      open Word32
      infix 6 & ^
      infix 5 >>
      fun a + b = Int.+ (a, b)
      fun a & b = andb (a, b)
      fun a ^ b = xorb (a, b)
      
      fun te0 w = Word32Vector.sub (Te0, Word32.toInt ((w >> 0w24)        ))
      fun te1 w = Word32Vector.sub (Te1, Word32.toInt ((w >> 0w16) & 0wxff))
      fun te2 w = Word32Vector.sub (Te2, Word32.toInt ((w >> 0w08) & 0wxff))
      fun te3 w = Word32Vector.sub (Te3, Word32.toInt ((w        ) & 0wxff))
      
      fun te40 w = Word32Vector.sub (Te4, Word32.toInt ((w >> 0w24)        )) & 0wxff000000
      fun te41 w = Word32Vector.sub (Te4, Word32.toInt ((w >> 0w16) & 0wxff)) & 0wx00ff0000
      fun te42 w = Word32Vector.sub (Te4, Word32.toInt ((w >> 0w08) & 0wxff)) & 0wx0000ff00
      fun te43 w = Word32Vector.sub (Te4, Word32.toInt ((w        ) & 0wxff)) & 0wx000000ff
      
      val sub = Word32Vector.sub
      
      fun round (rk, i) (s0, s1, s2, s3) =
         (te0(s0) ^ te1(s1) ^ te2(s2) ^ te3(s3) ^ sub (rk, i  ),
          te0(s1) ^ te1(s2) ^ te2(s3) ^ te3(s0) ^ sub (rk, i+1),
          te0(s2) ^ te1(s3) ^ te2(s0) ^ te3(s1) ^ sub (rk, i+2),
          te0(s3) ^ te1(s0) ^ te2(s1) ^ te3(s2) ^ sub (rk, i+3))
      
      fun finish (rk, i) (s0, s1, s2, s3) =
         (te40(s0) ^ te41(s1) ^ te42(s2) ^ te43(s3) ^ sub (rk, i  ),
          te40(s1) ^ te41(s2) ^ te42(s3) ^ te43(s0) ^ sub (rk, i+1),
          te40(s2) ^ te41(s3) ^ te42(s0) ^ te43(s1) ^ sub (rk, i+2),
          te40(s3) ^ te41(s0) ^ te42(s1) ^ te43(s2) ^ sub (rk, i+3))
   in
      fun encrypt128 (rk, input, output) =
         let
            val cipher = 
               writer output o finish (rk, 40) o
               round (rk, 36) o round (rk, 32) o round (rk, 28) o
               round (rk, 24) o round (rk, 20) o round (rk, 16) o
               round (rk, 12) o round (rk,  8) o round (rk,  4) o
               fetch rk
         in
            cipher input
         end
(*         
      fun encrypt192 (rk, input, output) =
         let
            val cipher = 
               writer output o finish (rk, 48) o
               round (rk, 44) o round (rk, 40) o
               round (rk, 36) o round (rk, 32) o round (rk, 28) o
               round (rk, 24) o round (rk, 20) o round (rk, 16) o
               round (rk, 12) o round (rk,  8) o round (rk,  4) o
               fetch rk
         in
            cipher input
         end
      
      fun encrypt256 (rk, input, output) =
         let
            val cipher = 
               writer output o finish (rk, 56) o round (rk, 52) o
               round (rk, 48) o round (rk, 44) o round (rk, 40) o
               round (rk, 36) o round (rk, 32) o round (rk, 28) o
               round (rk, 24) o round (rk, 20) o round (rk, 16) o
               round (rk, 12) o round (rk,  8) o round (rk,  4) o
               fetch rk
         in
            cipher input
         end
*)
   end

(*
   local
      open Word32
      infix 6 & ^
      infix 5 >>
      fun a + b = Int.+ (a, b)
      fun a & b = andb (a, b)
      fun a ^ b = xorb (a, b)
      
      fun td0 w = Word32Vector.sub (Td0, Word32.toInt ((w >> 0w24)        ))
      fun td1 w = Word32Vector.sub (Td1, Word32.toInt ((w >> 0w16) & 0wxff))
      fun td2 w = Word32Vector.sub (Td2, Word32.toInt ((w >> 0w08) & 0wxff))
      fun td3 w = Word32Vector.sub (Td3, Word32.toInt ((w        ) & 0wxff))
      
      fun td40 w = Word32Vector.sub (Td4, Word32.toInt ((w >> 0w24)        )) & 0wxff000000
      fun td41 w = Word32Vector.sub (Td4, Word32.toInt ((w >> 0w16) & 0wxff)) & 0wx00ff0000
      fun td42 w = Word32Vector.sub (Td4, Word32.toInt ((w >> 0w08) & 0wxff)) & 0wx0000ff00
      fun td43 w = Word32Vector.sub (Td4, Word32.toInt ((w        ) & 0wxff)) & 0wx000000ff
      
      fun sub (rk, i) = Word32Vector.sub (rk, i)
      
      fun round (rk, i) (s0, s1, s2, s3) =
         (td0(s0) ^ td1(s3) ^ td2(s2) ^ td3(s1) ^ sub (rk, i  ),
          td0(s1) ^ td1(s0) ^ td2(s3) ^ td3(s2) ^ sub (rk, i+1),
          td0(s2) ^ td1(s1) ^ td2(s0) ^ td3(s3) ^ sub (rk, i+2),
          td0(s3) ^ td1(s2) ^ td2(s1) ^ td3(s0) ^ sub (rk, i+3))
      
      fun finish (rk, i) (s0, s1, s2, s3) =
         (td40(s0) ^ td41(s3) ^ td42(s2) ^ td43(s1) ^ sub (rk, i  ),
          td40(s1) ^ td41(s0) ^ td42(s3) ^ td43(s2) ^ sub (rk, i+1),
          td40(s2) ^ td41(s1) ^ td42(s0) ^ td43(s3) ^ sub (rk, i+2),
          td40(s3) ^ td41(s2) ^ td42(s1) ^ td43(s0) ^ sub (rk, i+3))
   in
      fun decrypt128 (rk, b) =
         let
            val cipher =
               writer b o finish (rk, 40) o
               round (rk, 36) o round (rk, 32) o round (rk, 28) o
               round (rk, 24) o round (rk, 20) o round (rk, 16) o
               round (rk, 12) o round (rk,  8) o round (rk,  4) o
               fetch rk
         in
            cipher b
         end
      
      fun decrypt192 (rk, b) =
         let
            val cipher =
               writer b o finish (rk, 48) o
               round (rk, 44) o round (rk, 40) o
               round (rk, 36) o round (rk, 32) o round (rk, 28) o
               round (rk, 24) o round (rk, 20) o round (rk, 16) o
               round (rk, 12) o round (rk,  8) o round (rk,  4) o
               fetch rk
         in
            cipher b
         end
      
      fun decrypt256 (rk, b) =
         let
            val cipher =
               writer b o finish (rk, 56) o round (rk, 52) o
               round (rk, 48) o round (rk, 44) o round (rk, 40) o
               round (rk, 36) o round (rk, 32) o round (rk, 28) o
               round (rk, 24) o round (rk, 20) o round (rk, 16) o
               round (rk, 12) o round (rk,  8) o round (rk,  4) o
               fetch rk
         in
            cipher b
         end
   end
*)
in
   structure AES128ML :> CIPHER = 
      struct
         structure Key =
            struct
               type t = Word32Vector.vector
               val length = 4
               
               fun compare (a, b) =
                  let
                     val sa = Word32VectorSlice.slice (a, 0, SOME length) 
                     val sb = Word32VectorSlice.slice (b, 0, SOME length)
                  in
                     Word32VectorSlice.collate Word32.compare (sa, sb)
                  end
               structure Z = OrderFromCompare(type t = t val compare = compare)
               open Z
               
               fun hash k state =
                  Word32VectorSlice.foldl
                  (fn (x, state) => Hash.word32 x state)
                  state
                  (Word32VectorSlice.slice (k, 0, SOME length))
               
               val w = WordToString.from32 o Word32Vector.sub
               fun toString v =
                  concat [ w (v, 0), w (v, 1), w (v, 2), w (v, 3) ]
               
               val t = 
                  Serial.map {
                     store = fn v => 
                        (Word32Vector.sub (v, 0), Word32Vector.sub (v, 1),
                         Word32Vector.sub (v, 2), Word32Vector.sub (v, 3)),
                     load = fn (a, b, c, d) =>
                        Word32Array.vector (keySetupEnc128 (fn x =>
                        ( Word32Array.update (x, 0, a)
                        ; Word32Array.update (x, 1, b)
                        ; Word32Array.update (x, 2, c)
                        ; Word32Array.update (x, 3, d)))),
                     extra = fn () => ()
                  } w32x4b
            end
         
         val length = 16
         
         fun f { key, plain, cipher } = 
            encrypt128 (key, Word8ArraySlice.full plain, Word8ArraySlice.full cipher)
      end
end
